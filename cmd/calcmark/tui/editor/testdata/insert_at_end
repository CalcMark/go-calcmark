# Test insert line at end of document
# This tests the 'o' key at end + typing + Enter behavior

# Initial state - cursor at line 0
run observe=debug
----
-- debug:
mode=0 cursorLine=0 cursorCol=0 cursorVisual=0 cursorHighlight=0 scrollOffset=0 totalSource=4 totalVisual=4 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Navigate to last line (z = 30 at line 3)
run observe=debug
key j
key j
key j
----
-- debug:
mode=0 cursorLine=3 cursorCol=0 cursorVisual=3 cursorHighlight=3 scrollOffset=0 totalSource=4 totalVisual=4 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Press 'o' to insert line below at end of document
run observe=debug
key o
----
-- debug:
mode=1 cursorLine=4 cursorCol=0 cursorVisual=4 cursorHighlight=4 scrollOffset=0 totalSource=5 totalVisual=5 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Type some text
run observe=debug
type test
----
-- debug:
mode=1 cursorLine=4 cursorCol=4 cursorVisual=4 cursorHighlight=4 scrollOffset=0 totalSource=5 totalVisual=5 editBuf="test" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Press Enter - should create new line
run observe=debug
key enter
----
-- debug:
mode=1 cursorLine=5 cursorCol=0 cursorVisual=5 cursorHighlight=5 scrollOffset=0 totalSource=6 totalVisual=6 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Type more text on new line
run observe=debug
type more
----
-- debug:
mode=1 cursorLine=5 cursorCol=4 cursorVisual=5 cursorHighlight=5 scrollOffset=0 totalSource=6 totalVisual=6 editBuf="more" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Exit edit mode
run observe=debug
key esc
----
-- debug:
mode=0 cursorLine=5 cursorCol=4 cursorVisual=5 cursorHighlight=5 scrollOffset=0 totalSource=6 totalVisual=6 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Navigate up - should work correctly
run observe=debug
key k
----
-- debug:
mode=0 cursorLine=4 cursorCol=4 cursorVisual=4 cursorHighlight=4 scrollOffset=0 totalSource=6 totalVisual=6 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Navigate down
run observe=debug
key j
----
-- debug:
mode=0 cursorLine=5 cursorCol=4 cursorVisual=5 cursorHighlight=5 scrollOffset=0 totalSource=6 totalVisual=6 editBuf="" sourcePreviewMatch=true cursorInBounds=true highlightMatch=true mappingComplete=true

# Check visual structure
run observe=lines
----
-- lines:
sourceToVisual: map[0:0 1:1 2:2 3:3 4:4 5:5]
Visual lines:
  [0] srcIdx=0 lineNum=1 wrap=false pad=false content="# Header"
  [1] srcIdx=1 lineNum=2 wrap=false pad=false content="x = 10"
  [2] srcIdx=2 lineNum=3 wrap=false pad=false content="y = 20"
  [3] srcIdx=3 lineNum=4 wrap=false pad=false content="z = 30"
  [4] srcIdx=4 lineNum=5 wrap=false pad=false content="test"
  [5] srcIdx=5 lineNum=6 wrap=false pad=false content="more" <CURSOR>
